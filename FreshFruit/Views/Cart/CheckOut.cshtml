@model FreshFruit.Models.ViewModel.CheckOutViewModel

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            $("#checkout-form").submit(function (e) {
                e.preventDefault();

                const $submitBtn = $("#checkout-submit-btn");
                $submitBtn.prop("disabled", true).html('<span class="spinner-border spinner-border-sm"></span> Đang xử lý...');

                var formData = $(this).serialize();

                $.ajax({
                    type: "POST",
                    url: "/Cart/Checkout",
                    data: formData,
                    success: function (response) {
                        if (response.success) {
                            Swal.fire({
                                icon: 'success',
                                title: "Thành công",
                                text: `Bạn đã dặt hàng thành công, Mã đơn hàng của bạn là: ${response.invoice.invoiceCode}`,
                                icon: "success",
                                allowOutsideClick: true,
                            }).then(() => {
                                window.location.href = "/Cart";
                            });
                        } else {
                            Swal.fire("Thất bại", "Vui lòng kiểm tra lại thông tin.", "error");
                        }
                    },
                    error: function () {
                        Swal.fire("Lỗi", "Không thể gửi đơn hàng.", "error");
                    },
                    complete: function () {
                        $submitBtn.prop("disabled", false).html('<i class="fas fa-check-circle"></i> Xác nhận đặt hàng');
                    }
                });
            });
        });
    </script>
}

<div class="container py-5">
    <form asp-action="Checkout" asp-controller="Cart" method="post" id="checkout-form">
        <div class="row g-4">
            <!-- Thông tin khách hàng -->
            <div class="col-md-6">
                <h4 class="mb-3">🧍 Thông tin người nhận</h4>
                <input type="hidden" name="invoice.Total" value="@Model.TotalPrice" />

                <div class="form-floating mb-3">
                    <input type="text" class="form-control" value="@Model.FullName" readonly />
                    <label>Họ và tên</label>
                </div>

                <div class="form-floating mb-3">
                    <input type="text" class="form-control" value="@Model.Phone" readonly />
                    <label>Số điện thoại</label>
                </div>

                <div class="form-floating mb-3">
                    <input type="text" class="form-control" value="@Model.Address" readonly />
                    <label>Địa chỉ</label>
                </div>

                <div class="form-floating">
                    <select class="form-select" name="invoice.PaymentMethod" required>
                        <option value="">-- Chọn phương thức --</option>
                        <option value="Tiền mặt">Tiền mặt</option>
                        <option value="Chuyển khoản">Chuyển khoản</option>
                    </select>
                    <label>Phương thức thanh toán</label>
                </div>
            </div>

            <!-- Đơn hàng -->
            <div class="col-md-6">
                <h4 class="mb-3">🛒 Đơn hàng của bạn</h4>
                <div class="border rounded p-4 bg-light shadow-sm">
                    @foreach (var item in Model.CartItems)
                    {
                        <div class="d-flex justify-content-between border-bottom pb-2 mb-2">
                            <div>@item.Product.Name x @item.Quantity</div>
                            <div>@String.Format("{0:0,0}₫", item.Product.Price)</div>
                        </div>
                    }

                    <div class="d-flex justify-content-between mt-3 fs-5">
                        <strong>Tổng cộng</strong>
                        <strong>@String.Format("{0:0,0}₫", Model.TotalPrice)</strong>
                    </div>

                    <button type="submit" id="checkout-submit-btn" class="btn btn-success w-100 mt-4">
                        <i class="fas fa-check-circle me-2"></i> Xác nhận đặt hàng
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Font Awesome for icons -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
